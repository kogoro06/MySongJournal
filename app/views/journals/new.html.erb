<!-- 📖 日記フォーム -->
<div class="min-h-screen bg-customred  flex items-center justify-center py-10">
  <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-2xl space-y-6">
    <!-- form_with の local を true に設定 -->
    <%= form_with(model: @journal, local: true, id: "journal-form", class: "space-y-6") do |form| %>
      
      <!-- 📅 日付表示 -->
      <div class="text-center mb-4">
        <span class="text-xl font-semibold text-gray-700">
          <%= Time.now.strftime('%Y年%m月%d日') %>
        </span>
      </div>

      <!-- 📝 タイトル入力 -->
      <div>
        <%= form.label :title, "日記タイトル", class: "block text-xl font-medium text-black mb-2" %>
        <%= form.text_field :title, required: true, placeholder: "タイトルを入力", name: "journal[title]", class: "w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400 dark-mode-text",id: "journal-title" %>
      </div>

      <!-- 🎼 曲情報 -->
      <div class="bg-gray-100 p-4 text-center mt-6 rounded-lg shadow-inner">
        <% unless @journal.song_name.present? || @journal.artist_name.present? || @journal.album_image.present? %>
          <div class="text-xl font-bold text-gray-800 mb-4 flex items-center justify-center gap-2">
            <%= image_tag 'spotify.png', alt: 'Spotify Logo', class: 'inline h-6 w-6' %>
            Spotify曲検索
          </div>
        <% end %>

        <% if @journal.song_name.present? || @journal.artist_name.present? || @journal.album_image.present? %>
          <div class="text-xl font-bold text-gray-800 mb-4">
            🎵 選択した曲情報
          </div>

          <% if @journal.song_name.present? %>
          <div class="mb-2">
            <span id="selected-song-name" class="block text-lg font-medium text-gray-800">
              🎵 曲名: <%= @journal.song_name %>
            </span>
          </div>

          <% if @journal.spotify_track_id.present? %>
            <div class="mb-2">
              <span id="selected-artist-name" class="block text-lg font-medium text-gray-800">
                🎤 アーティスト: <%= @journal.artist_name %>
              </span>
            </div>
          <% end %>
          <% end %>
          <% if @journal.album_image.present? %>
            <div class="mb-4">
              <iframe style="border-radius:12px" 
                      src="https://open.spotify.com/embed/track/<%= @journal.spotify_track_id %>" 
                      width="100%"
                      height="352"
                      frameBorder="0" 
                      allowfullscreen="" 
                      allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" 
                      loading="lazy"
                      class="w-full rounded-lg">
              </iframe>
            </div>
          <% end %>

         <!-- ジャンル選択 -->
          <div class="mb-4">
            <div class="form-group">
              <%= form.label :genre, "ジャンル", class: "block text-md font-medium text-gray-700 mb-2" %>
              <%= form.select :genre, 
                Journal.genres.map { |k, v| [t("activerecord.attributes.journal.genre.#{k}"), k] },
                { include_blank: '選択してください' },
                { 
                  class: "w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400 dark-mode-text",
                }
              %>
            </div>
          </div>
        <% else %>
          <p class="text-gray-500">まずは曲を選んでください♫</p>
        <% end %>

        <!-- 🎯 モーダルを開くボタン -->
        <div class="flex gap-4 mt-6">
          <button type="button" id="open-search-modal" class="w-full px-4 py-2 bg-green-500 text-white font-medium rounded-md hover:bg-green-600 transition">
            <% if @journal.song_name.present? %>
              曲を選び直す♫
            <% else %>
              曲を選ぶ♫
            <% end %>
          </button>
        </div>
      </div>

      <!-- 🎼 隠しフィールドで曲情報を送信 -->
      <%= form.hidden_field :song_name, value: @journal.song_name, name: "journal[song_name]" %>
      <%= form.hidden_field :artist_name, value: @journal.artist_name, name: "journal[artist_name]" %>
      <%= form.hidden_field :album_image, value: @journal.album_image, name: "journal[album_image]" %>
      <%= form.hidden_field :preview_url, value: @journal.preview_url, name: "journal[preview_url]" %>
      <%= form.hidden_field :spotify_track_id, value: @journal.spotify_track_id, name: "journal[spotify_track_id]" %>

      <!-- 😊 感情入力 -->
      <div>
        <%= form.label :emotion, "感情", class: "block text-md font-medium text-black mb-2" %>
        <%= form.select :emotion, 
            Journal.emotions.map { |k, v| [k, k] }, 
            { prompt: "選択してください" }, 
            name: "journal[emotion]", 
            class: "w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400 dark-mode-text",
            id: "journal-emotion" %>
      </div>

      <!-- 📝 メモ入力 -->
      <div>
        <%= form.label :content, "本文", class: "block text-md font-medium text-black mb-2" %>
        <%= form.text_area :content, required: true, placeholder: "今日の出来事や気持ちを記入", name: "journal[content]", class: "w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400 dark-mode-text",id: "journal-content" %>
      </div>

      <!-- 公開設定 -->
      <div class="mb-4">
        <div class="flex items-center">
          <%= form.check_box :public, class: "h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500", style: "transform: scale(1.5);" %>
          <%= form.label :public, "タイムラインに投稿する", class: "ml-3 block text-gray-700 font-bold" %>
        </div>
        <p class="text-sm text-gray-600 mt-1">※チェックを外すと、タイムラインには表示されません</p>
      </div>


      <!-- 💾 保存ボタン -->
      <div class="text-center mt-6">
        <%= form.submit "📥 日記を保存", class: "w-full px-4 py-2 bg-blue-500 text-white font-medium rounded-md hover:bg-blue-600 transition text-lg" %>
      </div>
    <% end %>
  </div>
</div>

<%= render 'shared/spotify_modal' %>
